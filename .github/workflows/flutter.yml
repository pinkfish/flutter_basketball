name: Flutter - android

on: 
  release:
    types: [created,edited]

#  push:
#    branches: [master]
#    paths: 
#      - ux/**
#      - firebasedata/**
#      -  .github/workflows/flutter.yml


jobs:
  build:
   runs-on: ubuntu-latest

   steps:
    - uses: actions/checkout@v2
      with:
        repo-token: ${{ secrets.GITHUB_TOKEN }}   
    - uses: actions/setup-java@v1
      with:
        java-version: '12.x'
    - uses: subosito/flutter-action@v1
      with:
        repo-token: ${{ secrets.GITHUB_TOKEN }}   
        channel: 'stable' # or: 'dev' or 'beta'
    # Set up git with key and domain
    #- name: 'gcr.io/cloud-builders/git'
    #  env:
    #    GITHUB_TOKEN: ${{ secrets.github_token }}
    #  shell: bash
    #  run: |
    #     git remote add github "https://pinkfish:$GITHUB_TOKEN@github.com/charts.git"
          #mkdir -p ~/.ssh
          #echo ${GUTHUB_TOKEN} > ~/.ssh/id_rsa
          #chmod 600 ~/.ssh/id_rsa
          #cat <<EOF >~/.ssh/config
          #Hostname github.com
          #IdentityFile ~/.ssh/id_rsa
          #EOF
          #ssh-keyscan -t rsa github.com > known_hosts
          #mv known_hosts ~/.ssh/known_hosts
#    - run: git config --global url.”https://{token}:@github.com/".insteadOf “https://github.com/"
#      working-directory: ux
    - run: flutter pub get
      working-directory: basketballdata
    - run: flutter pub run build_runner build
      working-directory: basketballdata
    - run: flutter packages get
      working-directory: ux
    #- run: flutter test
    #  working-directory: ux
    #- name: Fastlane Action
    #  uses: maierj/fastlane-action@v1.4.0
    #  with:
    #    subdirectory: ux/android/fastlane
    #    lane: beta
    - run: echo ${GOOGLESERVICES} > android/app/google-services.json	
      working-directory: ux	
      env: 	
        GOOGLESERVICES: ${{ secrets.googleservicesAndroid }}
    - run: echo ${FASTLANE} > ~/app-fastlane.json	
      working-directory: ux	
      env: 	
        FASTLANE: ${{ secrets.fastlaneApp }}
   # - run: flutter build appbundle --target-platform android-arm,android-arm64,android-x64
   #   working-directory: ux
   # - name: Clean ruby cache	
   #   working-directory: ux/android	
   #   run: |	
   #     sudo gem install bundler	
   #     bundle install
   #     bundle clean
   #     rm -rf /home/runner/work/flutter_basketball/flutter_basketball/ux/android/fastlane/plugin/firebase_app_distribution
    - name: Fastlane Action
      uses: maierj/fastlane-action@v1.4.0
      with:
        lane: alpha
        subdirectory: ux/android
        options: '{"version": "${{ github.ref }}"}'
      env:
        FL_GITHUB_RELEASE_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - uses: matheusalbino/git-commit@v1.0.1
      with:
        user-name: pinkfishfrog
        user-email: pinkfishfrog@gmail.com
        message: Change notes for the new release.
        github-token: ${{ secrets.GITHUB_TOKEN }}
